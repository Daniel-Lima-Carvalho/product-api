name: CI and CD

on: 
  push:
    branches:
      - master

jobs:
  continuous-integration:
    name: CI and CD
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: 3.8.10
      
      - name: Install requirements
        run: |
            pip install -r requirements.txt
      
      - name: Run tests
        run: |
            python manage.py test
      
      - name: Deploy to AWS  
        env:
          PRIVATE_KEY: ${{ secrets.AWS_PRIVATE_KEY  }}
          HOSTNAME : ${{ secrets.AWS_HOST  }}
          USER_NAME : ${{ secrets.AWS_USERNAME  }}
       
         
        run: |
          echo "$PRIVATE_KEY" > private_key && chmod 600 private_key
          ssh -o StrictHostKeyChecking=no -i private_key ${USER_NAME}@${HOSTNAME} '
        
            cd product-api &&
            git checkout master &&
            git pull origin master &&
            source venv/bin/activate &&
            pip install -r requirements.txt &&
            python manage.py migrate &&
            sudo systemctl restart product_api &&
            sudo systemctl status product_api
          '
            
        